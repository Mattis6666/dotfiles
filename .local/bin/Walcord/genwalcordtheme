#!/usr/bin/python3

import re
import sys
from base64 import b64encode
from os.path import basename, splitext

to_match = [
    ("color1", "main-color"),
    ("color2", "hover-color"),
    ("foreground", "home-color"),
    ("wallpaper", "popup-background")
]

if len(sys.argv) < 3:
    print(f"Usage: {sys.argv[0]} <wal_colors.css> <base_bd_theme.theme.css> [output_bd_theme.theme.css]")
    sys.exit(0)

with open(sys.argv[1]) as f:
    wal = f.read()

with open(sys.argv[2]) as f:
    base = f.read()
    
cssvars = []

for inp, outp in to_match:
    matcher = f"--{inp}:\\s*([^;]+);"
    match = re.search(matcher, wal).group(1)
    if inp == "wallpaper":
        with open(match[5:-2], "rb") as f:
            _ ,ext = splitext(match[5:-2])
            b64 = b64encode(f.read()).decode()
            match = f"url(data:image/{ext[1:]};base64,{b64})"

    cssvars.append(f"--{outp}: {match};")

output = f"{base}\n/* Auto generated by {basename(sys.argv[0])} based on pywals color.css */\n:root {{\n\t" + "\n\t".join(cssvars) + "\n}"

if len(sys.argv) > 3:
    with open(sys.argv[3], "w+") as f:
        f.write(output)
        print(f"Saved theme to {sys.argv[3]}")
else:
    print(output)
